<!DOCTYPE html>
<html lang="es" ng-app="myApp" ng-controller="myController">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous">
        </script>

    <title>ROADMAPS</title>

    <link rel="shortcut icon" type="image/png" href="roadmaps.png" />

</head>

<body>

    <div class="container">
        <div class="row">
            <div class="col">
                <h1>ROADMAPS</h1>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <div id="index"></div>
            </div>
            <div id="selected"></div>
        </div>
        <div class="row">
            <p id="template"></p>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function (event) {
            let loadtemplate = function () {

                fetch("README.md").then(function (response) {
                    return response.text();
                }).then(function (code) {

                    const regexMdLinks = /\[([^\[]+)\](\(.*\))/gm
                    const matches = code.match(regexMdLinks)
                    terms = [];
                    links = [];

                    const singleMatch = /\[([^\[]+)\]\((.*)\)/
                    for (var i = 0; i < matches.length; i++) {
                        var text = singleMatch.exec(matches[i])
                        links.push({ t: text[1], l: text[2], w: 0, s: false })
                        words = text[1].match(/\w+|\s+|[^\s\w]+/g)
                        for (var j = 0; j < words.length; j++) {
                            if (words[j].length > 3) {
                                inside = false;
                                for (var k = 0; k < terms.length; k++) {
                                    if (words[j] == terms[k].w) {
                                        inside = true;
                                        terms[k].l.push(links.length);
                                        break;
                                    }
                                }
                                if (!inside) {
                                    terms.push({ w: words[j], l: [links.length], s: false });
                                }
                            } else {
                                if (words[j].startsWith("#")) {
                                    orderNumber = words[j].substring(words[j].indexOf('#') + 1)
                                    if (Number.isInteger(orderNumber)) {
                                        links[links.length - 1].w = orderNumber;                                        
                                    }

                                }
                            }
                        }                     
                    }
                    refreshTags();
                });

            }
            function refreshLinks() {
                links.filter(l => l.s == true).forEach(l => l.s = false);
                terms.filter(t => t.s == true).map(t => t.l).forEach(al => al.forEach(l => links[l].s = true));
            }
            function refreshBody() {
                refreshLinks();
                const visibleLinksArr = links.filter(l => l.s == true);
                const linksArrCode = visibleLinksArr.map(l => `<li><a href="${l.l}">${l.t} ${l.w}</a></li>`);
                const linksStrCode = linksArrCode.reduce((acc, curr) => acc + curr, '<ul>') + '</ul>';
                document.getElementById('template').innerHTML = linksStrCode;
            }
            function refreshTags() {
                //let resultSelected = terms.filter(term => term.s==true);
                index = "<p>";
                selected = "<p>";
                const fontFactor = 0.05;
                const fontMinimal = 0.6;
                for (var k = 0; k < terms.length; k++) {
                    if (!terms[k].s) {
                        index += `<a id="${k}" style="text-decoration:none;font-size:${fontMinimal + (terms[k].l.length * fontFactor)}em" class="m-1 tag badge rounded-pill bg-primary" href="#">${terms[k].w}</a>`;
                    } else {
                        selected += `<a id="${k}" style="text-decoration:none;font-size:${fontMinimal + (terms[k].l.length * fontFactor)}em" class="m-1 selectedtag badge rounded-pill bg-success" href="#">${terms[k].w}</a>`;
                    }
                }
                index += "</p>";
                selected += "</p>";

                const elemindex1 = document.getElementById('index');
                elemindex1.innerHTML = index;

                const elemindex2 = document.getElementById('selected');
                elemindex2.innerHTML = selected;

                assignTagEvents();
                assignSelectedTagEvents();

            }

            function assignTagEvents() {
                let tags = document.querySelectorAll('.tag');
                Array.from(tags).forEach(link => {
                    link.addEventListener('click', function (event) {
                        var number = event.target.getAttribute("id");
                        terms[number].s = !terms[number].s;
                        refreshTags();
                        refreshBody();
                        event.preventDefault();
                    });
                });
            }
            function assignSelectedTagEvents() {
                let tags = document.querySelectorAll('.selectedtag');
                Array.from(tags).forEach(link => {
                    link.addEventListener('click', function (event) {
                        var number = event.target.getAttribute("id");
                        terms[number].s = !terms[number].s;
                        refreshTags();
                        refreshBody();
                        event.preventDefault();
                    });
                });
            }
            loadtemplate();
        });
    </script>
</body>

</html>
